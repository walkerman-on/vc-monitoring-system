# Образ для сборки
FROM python:3.12-alpine as builder
# Установим рабочую директорию
WORKDIR /app
# Отключение буферизации вывода Python
ENV PYTHONUNBUFFERED=1
ENV PYFILE=opcua-controller.py
# Установим необходимые инструменты
RUN apk add --no-cache binutils
# Установка зависимостей
COPY requirements_controller.txt .
COPY regulators.py .
RUN pip install --no-cache-dir -r requirements_controller.txt

# Получение основного файла программы
COPY $PYFILE .
RUN pyinstaller --onefile --name=pyprog $PYFILE


# initd systemd

# Финальный минимальный образ
FROM alpine:latest
# Установим рабочую директорию
WORKDIR /app
COPY --from=builder /app/regulators.py .
# Скопируем программу после сборки в рабочую директорию
COPY --from=builder /app/dist/pyprog /app/pyprog
# Отключение буферизации вывода Python
ENV PYTHONUNBUFFERED=1

# Определение команды по умолчанию с полным путем
CMD ["/app/pyprog"]